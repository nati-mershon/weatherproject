import streamlit as st
import requests
import pandas as pd
import time

# ğŸ“Œ ×›×ª×•×‘×ª ×”×©×¨×ª â€“ ×¢×“×›×Ÿ ×œ×¤×™ ×”×›×ª×•×‘×ª ×”×—×™×¦×•× ×™×ª ×©×œ ×”×©×™×¨×•×ª!
API_BASE_URL = "http://4.234.52.245:5000"

# ğŸ¯ ×›×•×ª×¨×ª
st.title("ğŸŒ¤ Weather Service Dashboard")

# âœ… **×‘×“×™×§×ª Health**
st.header("ğŸ” Service Health Check")
if st.button("×‘×“×•×§ ××ª ×–××™× ×•×ª ×”×©×™×¨×•×ª"):
    health_response = requests.get(f"{API_BASE_URL}/healthz")
    if health_response.status_code == 200:
        st.success(f"âœ… ×”×©×™×¨×•×ª ×¤×¢×™×œ! {health_response.json()}")
    else:
        st.error(f"âŒ ×©×™×¨×•×ª ×œ× ×–××™×Ÿ! ×§×•×“: {health_response.status_code}")

# ğŸ“Š **×ª×¦×•×’×ª × ×ª×•× ×™ ××–×’ ××•×•×™×¨ (×¨×¢× ×•×Ÿ ××•×˜×•××˜×™)**
st.header("ğŸŒ¡ï¸ × ×ª×•× ×™ ××–×’ ××•×•×™×¨ ××—×¨×•× ×™×")

# ×”×•×¡×¤×ª ××¤×©×¨×•×ª ×œ×©×œ×™×˜×” ×‘×¨×¢× ×•×Ÿ ××•×˜×•××˜×™
auto_refresh = st.checkbox("ğŸ”„ ×¨×¢× ×•×Ÿ ××•×˜×•××˜×™ ×›×œ 5 ×©× ×™×•×ª", value=True)

def load_weather_data():
    weather_response = requests.get(f"{API_BASE_URL}/weather")
    if weather_response.status_code == 200:
        data = weather_response.json()
        if data:
            df = pd.DataFrame(data)
            df["date"] = pd.to_datetime(df["date"])  # ×”××¨×ª ×ª××¨×™×š ×œ×¤×•×¨××˜ × ×•×—
            return df
        else:
            st.warning("âš ï¸ ××™×Ÿ ×›×¨×’×¢ × ×ª×•× ×™× ×–××™× ×™×!")
    else:
        st.error(f"âŒ ×©×’×™××” ×‘×©×œ×™×¤×ª ×”× ×ª×•× ×™×! ×§×•×“: {weather_response.status_code}")
    return None

weather_data = load_weather_data()
if weather_data is not None:
    st.dataframe(weather_data)

# ğŸŒ **×”×¤×¢×œ×ª Fetch ×•××¢×§×‘ ××—×¨×™ ××¦×‘ ×”×ª×”×œ×™×š**
st.header("ğŸ“¥ ×”×•×¡×£ ×¢×™×¨ ×•×©×œ×•×£ × ×ª×•× ×™×")

if st.button("ğŸ“¡ Fetch ××–×’ ××•×•×™×¨"):
    fetch_response = requests.post(f"{API_BASE_URL}/fetch")
    if fetch_response.status_code == 200:
        st.success("âœ… ×”× ×ª×•× ×™× × ××¡×¤×™× ×›×¢×ª! ×‘×“×•×§ ×‘×¢×•×“ ×›××” ×©× ×™×•×ª.")
    elif fetch_response.status_code == 202:
        st.warning("â³ Fetch ×›×‘×¨ ××ª×‘×¦×¢, ×× × ×”××ª×Ÿ...")
    elif fetch_response.status_code == 409:
        st.error("âŒ Fetch ×›×‘×¨ ×¨×¥ ×‘×¨×§×¢! ×× × ×”××ª×Ÿ...")
    else:
        st.error(f"âŒ ×©×’×™××” ×‘×¢×ª Fetch! ×§×•×“: {fetch_response.status_code}")

# ğŸ—‘ï¸ **×›×¤×ª×•×¨ ××—×™×§×ª ×›×œ ×”× ×ª×•× ×™×**
st.header("ğŸ—‘ï¸ ××—×™×§×ª ×›×œ ×”× ×ª×•× ×™×")

if st.button("âŒ ××—×§ ××ª ×›×œ ×”× ×ª×•× ×™×"):
    delete_response = requests.delete(f"{API_BASE_URL}/clear_data")
    if delete_response.status_code == 200:
        st.success("âœ… ×›×œ ×”× ×ª×•× ×™× × ××—×§×• ×‘×”×¦×œ×—×”!")
        st.rerun()  # âœ… ×©×™××•×© ×‘×¤×•× ×§×¦×™×” ×”×¢×“×›× ×™×ª
    else:
        st.error(f"âŒ ×©×’×™××” ×‘××—×™×§×ª ×”× ×ª×•× ×™×! ×§×•×“: {delete_response.status_code}")
